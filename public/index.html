<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>LA RULETA DE LA SUERTE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <h1>LA RULETA DE LA SUERTE</h1>
    <p class="muted">Menor n√∫mero = Mayor prioridad.</p>

    <div class="row" style="margin-bottom: 12px">
      <label for="seasonSelect">A√±o de elecci√≥n de destinos</label>
      <select id="seasonSelect">
        <option value="" selected>Loading...</option>
      </select>
    </div>

    <div class="card">
      <h2>Destinos disponibles</h2>
      <p class="muted">
        Haz click en ‚ÄúA√±adir‚Äù para incluir el destino en tu lista. Puedes
        seleccionar tantos como quieras.
      </p>

      <div class="search-wrap">
        <input
          id="itemSearch"
          class="search-input"
          type="text"
          placeholder="Busca destinos por cualquier columna..."
        />
      </div>

      <div id="clickItems"></div>
    </div>

    <form id="submitForm">
      <h2>Enviar / Actualizar tu ranking</h2>
      <div class="row">
        <label for="name">Nombre</label>
        <input id="name" type="text" required placeholder="Fernando Alonso" />
        <label for="order"
          >Orden <i class="muted">(tu posici√≥n del BOE + 34)</i></label
        >
        <input
          id="order"
          type="number"
          required
          min="1"
          step="1"
          placeholder="1"
        />
      </div>

      <div class="card">
        <h3>Tus selecciones y orden</h3>
        <div class="quota">
          <div>Posici√≥n: <span id="quota" class="badge">0</span></div>
          <div>
            Seleccionados: <span id="selectedCount" class="badge">0</span>
          </div>
          <div>Restantes: <span id="remaining" class="badge">0</span></div>
        </div>
        <p class="drag-hint">
          Puedes seleccionar tantos como quieras. Arrastra para reordenar.
        </p>
        <div id="rankingTable"></div>
      </div>

      <input type="hidden" id="userId" />

      <div class="row row--mt">
        <button class="primary" type="submit">Guardar mis destinos</button>
        <button class="ghost" type="button" id="resetSelfBtn">
          Borrar mi usuario
        </button>
      </div>
      <div class="muted">
        El ID de tu usuario se guarda localmente en este navegador.
      </div>
      <p class="muted" style="color: red">
        Recuerda volver a acceder desde el mismo navegador y dispositivo para
        obtener tus destinos guardados y continuar donde lo dejaste, de lo
        contrario tendr√°s que volver a enviar tu ranking y se crear√° un registro
        duplicado.
      </p>
      <p class="muted" style="color: #666; font-size: 12px; margin-top: 8px">
        üí° <strong>Protecci√≥n anti-duplicados:</strong> Si tienes problemas de
        conexi√≥n, espera 15 segundos entre env√≠os para evitar registros
        duplicados.
      </p>
    </form>

    <div class="card">
      <h2>Reparto de destinos</h2>
      <div class="row">
        <label for="scenarioSelect"
          >Escenario de simulaci√≥n
          <i class="muted"
            ><span id="scenarioDescription"
              >Estado actual de la asignaci√≥n</span
            ></i
          ></label
        >
        <select
          id="scenarioSelect"
          style="
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
          "
        >
          <option value="0">Estado actual</option>
          <option value="1">Usuarios restantes se presentan</option>
          <option value="2">Destinos espec√≠ficos se ocupan</option>
          <option value="3">Bloqueo de preferencias</option>
        </select>
      </div>
      <p class="muted" style="margin-top: 8px; font-size: 14px">
        <strong>Estado actual:</strong> Asignaci√≥n normal con los usuarios
        reales existentes<br />
        <strong>Usuarios restantes:</strong> Si las personas que no han
        contestado presentaran sus solicitudes (los usuarios falsos generados
        tienen una mezcla de destinos populares y algo de aleatoriedad)<br />
        <strong>Destinos espec√≠ficos:</strong> Si destinos espec√≠ficos (por
        localidad y centro) se ocuparan<br />
        <strong>Bloqueo de preferencias:</strong> Si todos los usuarios por
        encima de ti obtuvieran sus X primeras opciones
      </p>

      <!-- Location/Centro Selection UI (hidden by default) -->
      <div
        id="locationSelectionUI"
        style="
          display: none;
          margin-top: 16px;
          padding: 16px;
          border: 1px solid #ddd;
          border-radius: 8px;
          background-color: #f9f9f9;
        "
      >
        <h4 style="margin: 0 0 12px 0; color: #333">
          Seleccionar destinos a bloquear:
        </h4>
        <p
          style="
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #666;
            font-style: italic;
          "
        >
          Se bloquear√°n solo los destinos que coincidan con AMBAS selecciones
          (localidad Y centro).
        </p>

        <div style="display: flex; gap: 20px; flex-wrap: wrap">
          <!-- Localidad Selection -->
          <div style="flex: 1; min-width: 200px">
            <label
              style="
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
                color: #555;
              "
              >Por Localidad:</label
            >
            <select
              id="localidadSelect"
              multiple
              style="
                width: 100%;
                height: 120px;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
              "
            >
              <!-- Options will be populated by JavaScript -->
            </select>
            <small style="color: #666; font-size: 12px"
              >Mant√©n Ctrl/Cmd para seleccionar m√∫ltiples</small
            >
          </div>

          <!-- Centro Selection -->
          <div style="flex: 1; min-width: 200px">
            <label
              style="
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
                color: #555;
              "
              >Por Centro de Destino:</label
            >
            <select
              id="centroSelect"
              multiple
              style="
                width: 100%;
                height: 120px;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
              "
            >
              <!-- Options will be populated by JavaScript -->
            </select>
            <small style="color: #666; font-size: 12px"
              >Mant√©n Ctrl/Cmd para seleccionar m√∫ltiples</small
            >
          </div>
        </div>

        <div style="margin-top: 12px">
          <button
            id="previewBlockedItems"
            style="
              padding: 8px 16px;
              background-color: #007bff;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
            "
          >
            Ver destinos que se bloquear√≠an
          </button>
          <button
            id="clearSelection"
            style="
              padding: 8px 16px;
              background-color: #6c757d;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
              margin-left: 8px;
            "
          >
            Limpiar selecci√≥n
          </button>
        </div>

        <div
          id="blockedItemsPreview"
          style="
            margin-top: 12px;
            padding: 12px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
          "
        >
          <h5 style="margin: 0 0 8px 0; color: #333">
            Destinos que se bloquear√≠an:
          </h5>
          <div id="blockedItemsList" style="font-size: 14px; color: #666">
            <!-- Blocked items will be listed here -->
          </div>
        </div>
      </div>

      <!-- Competition Depth UI for Scenario 3 (hidden by default) -->
      <div
        id="competitionDepthUI"
        style="
          display: none;
          margin-top: 16px;
          padding: 16px;
          border: 1px solid #ddd;
          border-radius: 8px;
          background-color: #f9f9f9;
        "
      >
        <h4 style="margin: 0 0 12px 0; color: #333">Configurar bloqueo:</h4>
        <p
          style="
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #666;
            font-style: italic;
          "
        >
          Especifica cu√°ntas primeras opciones de cada usuario por encima de ti
          se simular√°n como ocupadas.
        </p>

        <div style="display: flex; gap: 20px; align-items: center">
          <div>
            <label
              style="
                display: block;
                margin-bottom: 8px;
                font-weight: bold;
                color: #555;
              "
              >N√∫mero de opciones a bloquear:</label
            >
            <input
              id="competitionDepthInput"
              type="number"
              min="1"
              max="20"
              value="1"
              style="
                width: 80px;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
              "
            />
          </div>
          <div style="flex: 1">
            <p style="margin: 0; font-size: 14px; color: #666">
              <strong>Ejemplo:</strong> Si seleccionas "3", se simular√° que cada
              usuario por encima de ti obtiene sus 3 primeras opciones,
              reduciendo las opciones disponibles para ti.
            </p>
          </div>
        </div>
      </div>

      <div class="row">
        <button class="primary" id="allocateBtn">Repartir</button>
        <button class="ghost" id="resetAllBtn">
          Reiniciar todos mis destinos
        </button>
      </div>
      <div
        id="rateLimitCountdown"
        class="rate-limit-countdown"
        style="display: none"
      >
        <span class="rate-limit-icon">‚è≥</span>
        <span class="rate-limit-text"
          >Puedes ejecutar otra asignaci√≥n en:
          <span id="countdownTimer">--</span> segundos</span
        >
      </div>
      <div id="allocationResult" class="mt-12"></div>
    </div>

    <div class="card">
      <h2>Destinos enviados</h2>
      <div id="subs"></div>
    </div>

    <!-- Splash Screen -->
    <div id="splash">
      <div class="splash-backdrop"></div>
      <div class="splash-content">
        <div class="splash-inner">
          <h1 class="splash-title">
            SI LO S√â NO OPOSITO:
            <br />
            LA ELECCI√ìN
          </h1>

          <video
            id="splashVideo"
            class="splash-media"
            src="/assets/video/explosive_explosion.webm"
            muted
            playsinline
            autoplay
            loop
            poster="/assets/img/splash_poster.jpg"
          ></video>

          <p class="splash-subtitle">Hecho por alguien</p>
        </div>
      </div>
    </div>

    <!-- BUENA SUERTE overlay -->
    <div id="luckOverlay">
      <div class="luck-backdrop"></div>
      <div class="luck-content">
        <img src="/assets/img/pepe_pray.png" alt="Suerte" class="luck-img" />
        <div class="luck-text">BUENA SUERTE</div>
      </div>
    </div>

    <!-- Scripts: splash first, then app -->
    <script src="/splash.js"></script>
    <script src="/api.js"></script>
    <script src="/allocation.js"></script>
    <script src="/app.js"></script>
  </body>
</html>
