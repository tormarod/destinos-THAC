<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>LA RULETA DE LA MALA SUERTE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      body {
        margin: 24px;
      }
      form,
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      label {
        font-weight: 600;
      }
      input[type="text"],
      input[type="number"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      button {
        padding: 10px 14px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
      }
      button.primary {
        background: #2f6fed;
        color: white;
      }
      button.ghost {
        background: #e5e7eb;
      }
      .muted {
        color: #666;
        font-size: 0.9em;
      }
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        text-align: left;
        border-bottom: 1px solid #eee;
        padding: 8px;
      }
      td button.primary {
        background: #2f6fed;
        color: #fff;
        padding: 6px 10px;
      }
      td button.ghost {
        background: #e5e7eb;
        padding: 6px 10px;
      }
      td button {
        border-radius: 6px;
      }
      .quota {
        display: flex;
        gap: 16px;
        align-items: center;
      }
      .badge {
        background: #eef2ff;
        padding: 4px 8px;
        border-radius: 999px;
      }
      .drag-table tbody tr.dragging {
        opacity: 0.6;
        outline: 2px dashed #aaa;
      }
      .drag-hint {
        font-size: 0.9em;
        color: #555;
      }
      tr.top199 {
        background-color: #fffbe6; /* light blue highlight */
      }
      /* BUENA SUERTE overlay styles */
      #luckOverlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: none; /* toggled by JS */
      }
      #luckOverlay .luck-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(5px);
      }
      #luckOverlay .luck-content {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
      }
      #luckOverlay .luck-img {
        width: 160px;
        height: 160px;
        object-fit: contain;
        animation: luckSpinIn 800ms ease-out both;
      }
      #luckOverlay .luck-text {
        margin-top: 2px;
        color: #fff;
        font-weight: 800;
        letter-spacing: 1px;
        font-size: 48px;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        animation: luckFadeIn 600ms 150ms ease-out both;
      }

      @keyframes luckSpinIn {
        0% {
          transform: scale(0) rotate(-360deg);
          opacity: 0;
        }
        60% {
          transform: scale(3.1) rotate(-20deg);
          opacity: 1;
        }
        100% {
          transform: scale(3) rotate(0deg);
        }
      }
      @keyframes luckFadeIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Splash Screen (responsive + safe sizing) */
      #splash {
        position: fixed;
        inset: 0;
        z-index: 10000;
        display: none;
      }

      #splash .splash-backdrop {
        position: absolute;
        inset: 0;
        /* opaque background with subtle blue glow */
        background:rgba(0, 0, 0, 0.95);
      }

      #splash .splash-content {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        padding: 4vh 4vw; /* breathing room on tiny screens */
        overflow: hidden; /* prevents accidental scrollbars */
      }

      /* The layout column that scales safely on any screen */
      .splash-inner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
        /* Constrain overall size to the viewport */
        max-width: min(92vw, 900px);
        max-height: 86vh;
      }

      /* Responsive typography with clamp() */
      .splash-title {
        color: #fff;
        margin: 0;
        font-weight: 800;
        letter-spacing: 0.5px;
        font-size: clamp(1.5rem, 5vw, 2.6rem);
        text-align: center;
        text-shadow: 0 2px 12px rgba(0, 0, 0, 0.45);
        animation: splashPop 700ms ease-out both;
      }

      .splash-subtitle {
        color: #e6e8ff;
        margin: 0;
        font-weight: 600;
        opacity: 0.95;
        font-size: clamp(0.9rem, 2.6vw, 1.125rem);
        text-align: center;
        animation: splashFadeUp 700ms 120ms ease-out both;
      }

      /* Media (video or img) scales to viewport without overflow */
      .splash-media {
        width: min(80vw, 560px);
        max-height: 48vh; /* key: stays within screen height */
        height: auto;
        object-fit: contain;
        border-radius: 12px;
        animation: splashGifIn 600ms 120ms ease-out both;
      }

      /* Extra safety on very short displays */
      @media (max-height: 600px) {
        .splash-inner {
          gap: 0.9rem;
        }
        .splash-media {
          max-height: 38vh;
          width: min(82vw, 500px);
        }
      }

      /* Animations */
      @keyframes splashPop {
        0% {
          transform: scale(0.95);
          opacity: 0;
        }
        60% {
          transform: scale(1.03);
          opacity: 1;
        }
        100% {
          transform: scale(1);
        }
      }
      @keyframes splashFadeUp {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes splashGifIn {
        from {
          opacity: 0;
          transform: translateY(8px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Fade-out helper */
      #splash.fadeout {
        animation: splashFadeOut 450ms ease-in forwards;
      }
      @keyframes splashFadeOut {
        to {
          opacity: 0;
        }
      }

      /* Optional: prevent page scroll while splash is visible */
      body.splashing {
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <h1>LA RULETA DE LA SUERTE</h1>
    <p class="muted">
      Menor número = Mayor prioridad. Selecciona tantas opciones como quieras.
    </p>

    <div class="card">
      <h2>Destinos disponibles</h2>
      <p class="muted">
        Haz click en “Añadir” para incluir el destino en tu lista. Puedes
        seleccionar tantos como quieras.
      </p>
      <p class="muted">
        Los destinos con fondo amarillo son del anexo 1 (reserva de provincia)
      </p>

      <div style="margin-bottom: 10px">
        <input
          id="itemSearch"
          type="text"
          placeholder="Busca destinos por cualquier valor..."
          style="
            width: 60%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
          "
        />
      </div>

      <div id="clickItems"></div>
    </div>

    <form id="submitForm">
      <h2>Enviar / Actualizar tu ranking</h2>
      <div class="row">
        <label for="name">Nombre</label>
        <input
          id="name"
          type="text"
          required
          placeholder="e.g., Fernando Alonso"
        />
        <label for="order">Orden (tu número en la oposición)</label>
        <input
          id="order"
          type="number"
          required
          min="1"
          step="1"
          placeholder="1"
        />
      </div>

      <div class="card">
        <h3>Tus selecciones y orden</h3>
        <div class="quota">
          <div>Posición: <span id="quota" class="badge">0</span></div>
          <div>
            Seleccionados: <span id="selectedCount" class="badge">0</span>
          </div>
          <div>Restantes: <span id="remaining" class="badge">0</span></div>
        </div>
        <p class="drag-hint">
          Puedes seleccionar tantos como quieras. Arrastra para reordenar.
        </p>
        <div id="rankingTable"></div>
      </div>

      <input type="hidden" id="userId" />

      <div class="row" style="margin-top: 12px">
        <button class="primary" type="submit">Save my ranking</button>
        <button class="ghost" type="button" id="resetSelfBtn">
          Borrar mi usuario
        </button>
      </div>
      <div class="muted">
        El ID de tu usuario se guarda localmente en este navegador.
      </div>
    </form>

    <div class="card">
      <h2>Reparto de destinos</h2>
      <div class="row">
        <button class="primary" id="allocateBtn">Repartir</button>
        <button class="ghost" id="resetAllBtn">
          Reiniciar todos mis destinos
        </button>
      </div>
      <div id="allocationResult" style="margin-top: 12px"></div>
    </div>

    <div class="card">
      <h2>Destinos enviados</h2>
      <div id="subs"></div>
    </div>

    <!-- Splash Screen -->
    <div id="splash" style="display: none">
      <div class="splash-backdrop"></div>

      <!-- The inner container centers and constrains content -->
      <div class="splash-content">
        <div class="splash-inner">
          <h1 class="splash-title">
            Cómo evitar Catalunya:
            <br />
            El videojuego
          </h1>

          <!-- video or img fits within viewport safely -->
          <video
            id="splashVideo"
            class="splash-media"
            src="/explosive-explosion.webm"
            muted
            playsinline
            autoplay
            loop
            poster="/splash_poster.jpg"
          ></video>

          <p class="splash-subtitle">Hecho por Rodrigo Tortosa (y Gepeto)</p>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const state = {
        idField: "Nº vacante",
        items: [],
        itemsById: new Map(), // id -> object
        ranking: [], // array of IDs (Nº vacante)
        quota: 0,
        maxClickable: 9999999, // render subset for performance
        maxItemsTable: 9999999, // preview subset in Items table
        searchTerm: "",
      };

      // Local ID storage
      const LOCAL_KEY = "allocator:userId";
      const getLocalUserId = () => localStorage.getItem(LOCAL_KEY) || "";
      const setLocalUserId = (id) => localStorage.setItem(LOCAL_KEY, id);
      const clearLocalUserId = () => localStorage.removeItem(LOCAL_KEY);

      // Label for a row
      function labelFor(o) {
        if (!o) return "(unknown)";
        const id = o[state.idField];
        const parts = [];
        if (o["Centro de destino"]) parts.push(o["Centro de destino"]);
        if (o["Localidad"]) parts.push(o["Localidad"]);
        if (o["Provincia"]) parts.push(o["Provincia"]);
        return `#${id} · ${parts.join(" · ")}`.replace(/ · $/, "");
      }

      // -------- Clickable items table (Add/Remove with quota) --------
      function renderClickableItems() {
        const ct = $("clickItems");
        ct.innerHTML = "";
        // Filter items based on search term (case-insensitive)
        const filtered = state.searchTerm
          ? state.items.filter((o) =>
              Object.values(o).some(
                (v) =>
                  v &&
                  String(v)
                    .toLowerCase()
                    .includes(state.searchTerm.toLowerCase())
              )
            )
          : state.items;

        const items = filtered.slice(0, state.maxClickable);
        if (!items.length) {
          ct.innerHTML = "<p class='muted'>No items loaded.</p>";
          return;
        }

        const cols = [
          state.idField,
          "Centro de destino",
          "Localidad",
          "Provincia",
          "Horario/ATF",
        ].filter(
          (c) => items[0] && Object.prototype.hasOwnProperty.call(items[0], c)
        );

        const rows = items
          .map((o) => {
            const id = String(o[state.idField]);
            const isActive = state.ranking.includes(id);
            const btnLabel = isActive ? "Eliminar" : "Añadir";
            const btnClass = isActive ? "primary" : "ghost";
            // Determine if this item's "Nº vacante" is between 1 and 200
            const num = parseInt(o[state.idField], 10);
            const highlight =
              !isNaN(num) && num >= 1 && num <= 199 ? "top199" : "";

            return `
  <tr class="${highlight}">
    ${cols.map((c) => `<td>${o[c] != null ? o[c] : ""}</td>`).join("")}
    <td style="text-align:right;">
      <button type="button" class="${btnClass}" data-id="${id}">${btnLabel}</button>
    </td>
  </tr>
`;
          })
          .join("");

        ct.innerHTML = `
        <table>
          <thead>
            <tr>
              ${cols.map((c) => `<th>${c}</th>`).join("")}
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        ${
          state.items.length > items.length
            ? `<div class="muted" style="margin-top:8px;">Mostrando ${items.length} de ${state.items.length} destinos para elección rápida.</div>`
            : ""
        }
            ${
              filtered.length < state.items.length
                ? `<div class="muted" style="margin-top:8px;">Filtrado a ${filtered.length} destinos coincidentes.</div>`
                : ""
            }
      `;

        // Wire buttons
        ct.querySelectorAll("button[data-id]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const idx = state.ranking.indexOf(id);
            if (idx >= 0) {
              state.ranking.splice(idx, 1);
            } else {
              state.ranking.push(id);
            }
            renderClickableItems();
            renderRankingTable();
            updateQuotaIndicators();
          });
        });
      }

      // -------- Drag & drop ranking (table) --------
      function renderRankingTable() {
        const ct = $("rankingTable");
        const ids = state.ranking;
        if (!ids.length) {
          ct.innerHTML =
            "<p class='muted'>No hay selecciones aún. Añade destinos de la tabla superior.</p>";
          return;
        }

        const rows = ids
          .map((id, idx) => {
            const o = state.itemsById.get(String(id));
            return `
          <tr draggable="true" data-index="${idx}">
            <td style="width:40px;cursor:grab;">↕</td>
            <td><strong>${id}</strong></td>
            <td>${o ? o["Centro de destino"] || "" : ""}</td>
            <td>${o ? o["Localidad"] || "" : ""}</td>
            <td>${o ? o["Provincia"] || "" : ""}</td>
            <td style="text-align:right;">
              <button type="button" class="ghost" data-remove="${id}">Eliminar</button>
            </td>
          </tr>
        `;
          })
          .join("");

        ct.innerHTML = `
        <table class="drag-table">
          <thead>
            <tr>
              <th style="width:40px;"></th>
              <th>${state.idField}</th>
              <th>Centro de destino</th>
              <th>Localidad</th>
              <th>Provincia</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

        // Remove buttons
        ct.querySelectorAll("button[data-remove]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.remove;
            const idx = state.ranking.indexOf(id);
            if (idx >= 0) state.ranking.splice(idx, 1);
            renderClickableItems();
            renderRankingTable();
            updateQuotaIndicators();
          });
        });

        // Drag logic
        const tbody = ct.querySelector("tbody");
        let dragIndex = null;

        tbody.querySelectorAll("tr").forEach((tr) => {
          tr.addEventListener("dragstart", (e) => {
            dragIndex = Number(tr.dataset.index);
            tr.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
          });
          tr.addEventListener("dragend", () => {
            tr.classList.remove("dragging");
          });
          tr.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
            const over = e.currentTarget;
            const overIndex = Number(over.dataset.index);
            if (overIndex === dragIndex) return;
          });
          tr.addEventListener("drop", (e) => {
            e.preventDefault();
            const overIndex = Number(e.currentTarget.dataset.index);
            if (dragIndex === null || overIndex === dragIndex) return;
            // Reorder array
            const moved = state.ranking.splice(dragIndex, 1)[0];
            state.ranking.splice(overIndex, 0, moved);
            // Re-render with new indexes
            renderRankingTable();
            updateQuotaIndicators();
          });
        });
      }

      function updateQuotaIndicators() {
        const selected = state.ranking.length;
        const quota = state.quota;
        const remaining = quota - selected; // may be negative; purely informative
        $("quota").textContent = String(quota);
        $("selectedCount").textContent = String(selected);
        $("remaining").textContent = String(remaining);
      }

      // -------- Submissions & Allocation rendering --------
      function renderSubs(subs) {
        const ct = $("subs");
        const localId = getLocalUserId();

        if (!localId) {
          ct.innerHTML =
            "<p class='muted'>No hay ID de usuario local. Envia tu ranking para crear un usuario.</p>";
          return;
        }

        const mine = subs.filter((s) => s.id === localId);
        if (!mine.length) {
          ct.innerHTML =
            "<p class='muted'>No hay destinos para este usuario.</p>";
          return;
        }

        const rows = mine
          .sort((a, b) => a.order - b.order || a.submittedAt - b.submittedAt)
          .map(
            (s) => `
      <tr>
        <td>${s.order}</td>
        <td>${s.name}</td>
        <td>${(s.rankedItems || []).join(" » ")}</td>
        <td class="muted">${new Date(s.submittedAt).toLocaleString()}</td>
      </tr>
    `
          )
          .join("");

        ct.innerHTML = `
    <table>
      <thead>
        <tr><th>Order/Quota</th><th>Name</th><th>Ranking (Nº vacante)</th><th>Submitted</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
      }

      function renderAllocation(payload) {
        const ct = $("allocationResult");
        const localId = getLocalUserId();

        if (!localId) {
          ct.innerHTML =
            "<p class='muted'>No hay ID de usuario local. Envia tu ranking para crear un usuario.</p>";
          return;
        }

        // Find only the current user's allocation
        const mine = payload.allocation.filter((r) => r.userId === localId);
        if (!mine.length) {
          ct.innerHTML =
            "<p class='muted'>No tienes destinos asignados aún.</p>";
          return;
        }

        const rows = mine
          .map((r) => {
            const firstAssigned =
              r.assignedItemIds && r.assignedItemIds.length > 0
                ? r.assignedItemIds[0]
                : "<span class='muted'>None</span>";

            const rankingNums = (r.rankedItems || []).join(" » ");

            return `
      <tr>
        <td><strong>${firstAssigned}</strong></td>
      </tr>
    `;
          })
          .join("");

        ct.innerHTML = `
    <table>
      <thead>
        <tr><th>Destino asignado: Nº vacante</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
      }

      // -------- API --------
      async function fetchState() {
        const res = await fetch("/api/state");
        const data = await res.json();

        // Base state
        state.items = data.items || [];
        state.idField = data.idField || state.idField;
        state.itemsById = new Map(
          state.items.map((o) => [String(o[state.idField]), o])
        );

        // Try to hydrate from local user's last submission
        const localId = getLocalUserId();
        let prefill = null;
        if (localId && Array.isArray(data.submissions)) {
          prefill = data.submissions.find((s) => s.id === localId) || null;
        }

        // If we have a saved submission, preload it into the UI/state
        if (prefill) {
          // Prefill inputs
          $("name").value = prefill.name || "";
          $("order").value = Number(prefill.order) || 0;

          // Set quota and ranking (filter to existing items, keep order)
          state.quota = Math.max(0, Number(prefill.order) || 0);
          state.ranking = (prefill.rankedItems || [])
            .map((id) => String(id))
            .filter((id) => state.itemsById.has(id));
        } else {
          // No local submission yet: keep current input values
          state.quota = Math.max(0, Number($("order").value) || 0);
          // Do not wipe ranking here; user might have started selecting before fetch completes
          state.ranking = state.ranking.filter((id) => state.itemsById.has(id));
        }

        // Render everything in correct order so buttons reflect selected items
        renderClickableItems();
        renderRankingTable();
        renderSubs(data.submissions || []); // this will already filter to local user in your updated version
        updateQuotaIndicators();
      }

      async function submitRanking(e) {
        e.preventDefault();
        const name = $("name").value.trim();
        const orderVal = Number($("order").value);
        const rankedItems = [...state.ranking];
        const id = $("userId").value || getLocalUserId() || undefined;

        if (!name || !orderVal || !rankedItems.length) {
          return alert(
            "Please fill name, order, and select at least one item."
          );
        }

        const res = await fetch("/api/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, order: orderVal, rankedItems, id }),
        });
        const data = await res.json();
        if (!res.ok) return alert(data.error || "Submission failed.");
        if (data.id) {
          setLocalUserId(data.id);
          $("userId").value = data.id;
        }
        await fetchState();
        alert("Saved!");
      }

      async function runAllocation() {
        // Show the BUENA SUERTE splash
        showLuckOverlay();

        // Start the allocation request
        const fetchPromise = (async () => {
          const res = await fetch("/api/allocate", { method: "POST" });
          const data = await res.json();
          renderAllocation(data);
        })();

        // Ensure the splash is visible for at least 1.1s (feel free to tweak)
        await Promise.all([fetchPromise, sleep(3000)]);

        // Hide the splash
        hideLuckOverlay();
      }

      async function resetAll() {
        const localId = getLocalUserId();
        if (!localId) {
          alert(
            "No local user ID found. Submit once to create your user first."
          );
          return;
        }
        if (!confirm("Remove ONLY this browser user’s submissions?")) return;

        const res = await fetch("/api/reset-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: localId }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          alert(data.error || "Failed to reset your submissions.");
          return;
        }

        // Clear local UI state
        // (keep localId so future updates still map to same user unless you want to clear it)
        // If you want to also clear the local ID, uncomment the next two lines:
        // clearLocalUserId();
        // $("userId").value = "";

        // Clear current picks and refresh from server
        state.ranking = [];
        await fetchState();
        $("allocationResult").innerHTML = "";
        alert(`Removed ${data.removed ?? 0} submission(s) for this user.`);
      }

      // Wire up
      $("submitForm").addEventListener("submit", submitRanking);
      $("allocateBtn").addEventListener("click", runAllocation);
      $("resetAllBtn").addEventListener("click", resetAll);
      $("itemSearch").addEventListener("input", (e) => {
        state.searchTerm = e.target.value.trim();
        renderClickableItems();
      });
      $("resetSelfBtn").addEventListener("click", () => {
        resetAll();
        clearLocalUserId();
        $("userId").value = "";
        alert(
          "Cleared your local user ID. Future submissions will create a new one."
        );
      });

      // Keep quota indicators in sync with the Order input
      $("order").addEventListener("input", () => {
        state.quota = Math.max(0, Number($("order").value) || 0);
        renderClickableItems();
        updateQuotaIndicators();
      });

      // Prefill local user id if present
      $("userId").value = getLocalUserId();

      // Initialize
      fetchState().then(() => {
        state.quota = Math.max(0, Number($("order").value) || 0);
        updateQuotaIndicators();
      });

      function showLuckOverlay() {
        const el = document.getElementById("luckOverlay");
        if (el) el.style.display = "block";
      }
      function hideLuckOverlay() {
        const el = document.getElementById("luckOverlay");
        if (el) el.style.display = "none";
      }
      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      // Adjust this to control splash length
      const SPLASH_MIN_MS = 5000; // adjust as you like

      function showSplash() {
        document.body.classList.add("splashing");
        const el = document.getElementById("splash");
        if (!el) return;
        el.style.display = "block";

        const v = document.getElementById("splashVideo");
        if (v) v.play().catch(() => {});
      }

      function hideSplash() {
        const el = document.getElementById("splash");
        if (!el) return;

        // stop video and fade out
        const v = document.getElementById("splashVideo");
        if (v) {
          v.pause();
          try {
            v.currentTime = 0;
          } catch {}
        }

        el.classList.add("fadeout");
        setTimeout(() => {
          el.classList.remove("fadeout");
          el.style.display = "none";
          document.body.classList.remove("splashing");
        }, 480);
      }

      // Match video speed to splash duration
      document.addEventListener("DOMContentLoaded", async () => {
        const v = document.getElementById("splashVideo");

        if (v) {
          // Once metadata is ready, adjust speed so 1 loop ≈ SPLASH_MIN_MS
          v.addEventListener(
            "loadedmetadata",
            () => {
              const targetSec = SPLASH_MIN_MS / 1000;
              // If the video reports a finite duration, scale speed:
              if (isFinite(v.duration) && v.duration > 0) {
                v.playbackRate = v.duration / targetSec;
              }
              // Kick playback just in case
              v.play().catch(() => {});
            },
            { once: true }
          );
        }

        showSplash();

        // Keep splash visible for at least SPLASH_MIN_MS
        await new Promise((r) => setTimeout(r, SPLASH_MIN_MS));
        hideSplash();
      });
    </script>
    <!-- BUENA SUERTE overlay -->
    <div id="luckOverlay" style="display: none">
      <div class="luck-backdrop"></div>
      <div class="luck-content">
        <!-- Put your image file in /public as suerte.png or change the src -->
        <img src="/pepe-pray.png" alt="Suerte" class="luck-img" />
        <div class="luck-text">BUENA SUERTE</div>
      </div>
    </div>
  </body>
</html>
